<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>天心苑・徹夜精誠 出席カウンター（Google同期版）</title>


<link rel="icon" href="icon.png?v=2" type="image/png">
<link rel="apple-touch-icon" href="icon.png?v=2">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
  :root { --fg:#222; --muted:#666; --bg:#fff; --accent:#2d7ff9; --grid:#e8e8e8; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; color:var(--fg); background:var(--bg); margin:0; }
  header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--grid); position:sticky; top:0; background:var(--bg); z-index:1; }
  .title { font-size:18px; font-weight:700; }
  .counts { font-size:14px; color:var(--muted); display:flex; gap:16px; flex-wrap:wrap; }
  .nav { display:flex; align-items:center; gap:8px; }
  button { cursor:pointer; border:1px solid var(--grid); background:#fafafa; padding:6px 10px; border-radius:8px; }
  button:hover { background:#f2f2f2; }
  main { max-width:820px; margin:0 auto; padding:16px; }
  .calendar { border:1px solid var(--grid); border-radius:12px; overflow:hidden; }
  .cal-head { display:grid; grid-template-columns: repeat(7, 1fr); background:#fafafa; border-bottom:1px solid var(--grid); }
  .cal-head div { padding:10px 0; text-align:center; font-weight:700; font-size:13px; }
  .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
  .cell { border-right:1px solid var(--grid); border-bottom:1px solid var(--grid); min-height:82px; padding:6px; position:relative; }
  .cell:nth-child(7n) { border-right:none; }
  .num { font-size:12px; color:var(--muted); }
  .tag { position:absolute; right:6px; bottom:6px; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--grid); color:var(--muted); background:#fff; }
  .weekday { background:#fff; }
  .weekend { background:#fcfcfc; color:#bbb; }
  .other-month { color:#c8c8c8; }
  .disabled { opacity:0.4; pointer-events:none; }
  .selected { outline:2px solid var(--accent); outline-offset:-2px; background:#eef4ff; }
  .today .num { color:var(--accent); font-weight:700; }
  .legend { display:flex; gap:12px; align-items:center; font-size:13px; color:var(--muted); margin:12px 0 0; flex-wrap:wrap; }
  .dot { width:10px; height:10px; border-radius:2px; display:inline-block; margin-right:6px; border:1px solid var(--grid); }
  .dot.weekend { background:#fcfcfc; }
  .dot.selected { background:#eef4ff; border-color:var(--accent); }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .spacer { flex:1; }
  .streaks { margin-top:10px; font-size:14px; color:var(--muted); display:flex; gap:16px; flex-wrap:wrap; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--grid); border-radius:999px; background:#fff; }
  .pill b { color:var(--fg); }
  @media (max-width:560px){
    .cell { min-height:64px; }
    .counts { flex-direction:column; gap:4px; }
  }
</style>
</head>
<body>
<header>
  <div class="title">天心苑・徹夜精誠 出席カウンター（同期版）</div>
  <div class="counts">
    <div id="monthCount">今月: 0 回</div>
    <div id="totalCount">累計: 0 回</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <div class="nav">
      <button id="prevBtn">◀︎</button>
      <div id="ymLabel" style="min-width:140px;text-align:center;font-weight:700;"></div>
      <button id="nextBtn">▶︎</button>
    </div>

    <button id="quickMarkBtn">今すぐ出席登録</button>
    <button id="selectMonthBtn">この月を全選択</button>

    <div class="spacer"></div>

    <button id="loadServerBtn">サーバーから読込</button>
    <button id="saveServerBtn">サーバーへ保存</button>

    <button id="downloadBtn">CSV</button>
    <button id="jsonExportBtn">JSON出力</button>

    <label>
      <input id="jsonImportInput" type="file" accept="application/json" style="display:none">
      <button id="jsonImportBtn">JSON入力</button>
    </label>

    <button id="resetBtn">リセット</button>
  </div>

  <div class="streaks">
    <span class="pill">現在の連続日数: <b id="currentStreak">0</b> 回</span>
    <span class="pill">最長連続日数: <b id="bestStreak">0</b> 回</span>
    <span class="pill">今月の皆勤: <b id="perfectThisMonth">-</b> <span id="perfectThisMonthDetail"></span></span>
  </div>

  <div class="calendar" id="calendar"></div>

  <div class="legend">
    <span><span class="dot weekend"></span>土日（選択不可）</span>
    <span><span class="dot selected"></span>選択＝出席</span>
  </div>
</main>

<script>
/* ====================== 設定 ====================== */
const START_DATE = "";
const END_DATE   = "";
const KEY = "weekdayAttendanceDates_tenshinen";

/* ★★★★★ 必ずここを自分のURLに変更する ★★★★★ */
const SERVER_URL = "https://script.google.com/macros/s/AKfycbwn64TD1AaB2DIJghnB0atWlkmDHVdz0hFwkTdirOlUU6MlL8PRt6WinAcmq-C6Fg-m9g/exec";

/* ===================== 基本関数 ===================== */
const fmt = d => d.toISOString().slice(0,10);
const jpWeek = ["日","月","火","水","木","金","土"];
const jpYM = (y,m)=> `${y}年${m}月`;
const parseISO = iso => { const [Y,M,D] = iso.split("-").map(Number); return new Date(Y,M-1,D); };

function loadSet(){ try{ return new Set(JSON.parse(localStorage.getItem(KEY)||"[]")); }catch(e){ return new Set(); } }
function saveSet(s){ localStorage.setItem(KEY, JSON.stringify([...s].sort())); }

function isWeekday(d){ const w=d.getDay(); return w>=1 && w<=5; }
function inRange(date){
  if(START_DATE && date < parseISO(START_DATE)) return false;
  if(END_DATE   && date > parseISO(END_DATE))   return false;
  return true;
}

function listEligibleWeekdays(from, to){
  const days=[]; const d=new Date(from);
  while(d<=to){
    if(isWeekday(d) && inRange(d)) days.push(new Date(d));
    d.setDate(d.getDate()+1);
  }
  return days;
}

/* ===================== 連続日数 ===================== */
function computeStreaks(selected){
  const minDate = START_DATE ? parseISO(START_DATE) : new Date(2000,0,1);
  const today = new Date();
  const maxDate = END_DATE ? parseISO(END_DATE) : today;
  const end = maxDate>today ? today : maxDate;

  const eligibles = listEligibleWeekdays(minDate,end).map(d=>fmt(d));
  let best=0,cur=0;

  for(const iso of eligibles){
    if(selected.has(iso)){ cur++; best=Math.max(best,cur); }
    else cur=0;
  }
  return {current:cur, best};
}

function computePerfectMonth(selected,y,m){
  const f=new Date(y,m,1);
  const l=new Date(y,m+1,0);
  const days=listEligibleWeekdays(f,l);
  const total=days.length;
  const attended=days.filter(d=>selected.has(fmt(d))).length;
  return { perfect:(total>0 && attended===total), attended, totalWeekdays:total };
}

/* ======================= 描画 ======================= */
const calEl=document.getElementById("calendar");
let current = (()=>{ const t=new Date(); return new Date(t.getFullYear(),t.getMonth(),1); })();

function render(){
  const selected=loadSet();
  calEl.innerHTML="";

  const y=current.getFullYear();
  const m=current.getMonth();

  document.getElementById("ymLabel").textContent = jpYM(y,m+1);

  const head=document.createElement("div");
  head.className="cal-head";
  jpWeek.forEach(w=>{ const d=document.createElement("div"); d.textContent=w; head.appendChild(d); });
  calEl.appendChild(head);

  const first=new Date(y,m,1);
  const start=new Date(first); start.setDate(1-first.getDay());

  const grid=document.createElement("div");
  grid.className="cal-grid";

  let monthCount=0;

  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const other=d.getMonth()!==m;
    const weekday=isWeekday(d);
    const id=fmt(d);

    const cell=document.createElement("div");
    cell.className="cell " + (weekday?"weekday":"weekend");
    if(other) cell.classList.add("other-month");
    if(fmt(new Date())===id) cell.classList.add("today");

    const selectable = weekday && inRange(d);
    if(!selectable) cell.classList.add("disabled");

    const num=document.createElement("div");
    num.className="num";
    num.textContent=d.getDate();
    cell.appendChild(num);

    const tag=document.createElement("div");
    tag.className="tag";
    tag.textContent=weekday?"平日":"休";
    cell.appendChild(tag);

    if(selected.has(id)){
      cell.classList.add("selected");
      if(!other && weekday) monthCount++;
    }

    if(selectable){
      cell.style.cursor="pointer";
      cell.addEventListener("click",()=>{
        const set=loadSet();
        if(set.has(id)) set.delete(id);
        else set.add(id);
        saveSet(set);
        render();
        saveToServer(false);  // ←自動保存（通知なし）
      });
    }

    grid.appendChild(cell);
  }
  calEl.appendChild(grid);

  document.getElementById("monthCount").textContent = `今月: ${monthCount} 回`;

  const total=[...selected].filter(iso=>{
    const d=parseISO(iso);
    return isWeekday(d) && inRange(d);
  }).length;
  document.getElementById("totalCount").textContent=`累計: ${total} 回`;

  const {current:cur,best}=computeStreaks(selected);
  document.getElementById("currentStreak").textContent=cur;
  document.getElementById("bestStreak").textContent=best;

  const pm=computePerfectMonth(selected,y,m);
  document.getElementById("perfectThisMonth").textContent = pm.perfect?"✅ 達成":"❌ 未達";
  document.getElementById("perfectThisMonthDetail").textContent = `（${pm.attended}/${pm.totalWeekdays}）`;
}

// ====================== サーバー同期 ======================
async function loadFromServer(){
  try{
    const res = await fetch(SERVER_URL);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    if(!Array.isArray(data.dates)) throw new Error("bad format");

    saveSet(new Set(data.dates));
    render();
    alert("サーバーから読み込みました！");
  }catch(e){
    console.error(e);
    alert("サーバー読み込みエラー");
  }
}

// ←ここを修正
async function saveToServer(showAlert = true){
  try{
    const dates = [...loadSet()].sort();

    const res = await fetch(SERVER_URL, {
      method: "POST",
      // headers は付けない（プリフライト防止）
      body: JSON.stringify({ dates })
    });

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      if (showAlert) {
        alert("サーバー保存エラー\nHTTPステータス: " + res.status + "\n" + text);
      }
      console.error("save error", res.status, text);
      return;
    }

    if (showAlert) {
      alert("サーバーへ保存しました！");
    }
  } catch (e) {
    console.error(e);
    if (showAlert) {
      alert("サーバー保存エラー（通信エラー）\n" + e);
    }
  }
}



/* ======================= 操作 ======================= */
document.getElementById("prevBtn").addEventListener("click",()=>{ current.setMonth(current.getMonth()-1); render(); });
document.getElementById("nextBtn").addEventListener("click",()=>{ current.setMonth(current.getMonth()+1); render(); });

document.getElementById("loadServerBtn").addEventListener("click",loadFromServer);
document.getElementById("saveServerBtn").addEventListener("click", () => saveToServer(true));

document.getElementById("downloadBtn").addEventListener("click",()=>{
  const set=loadSet();
  const rows=[["date","weekday","attended"]];
  [...set].sort().forEach(iso=>{
    const d=parseISO(iso);
    rows.push([iso,jpWeek[d.getDay()],1]);
  });
  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="attendance.csv"; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("jsonExportBtn").addEventListener("click",()=>{
  const payload={version:1,dates:[...loadSet()].sort()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="attendance_backup.json"; a.click();
  URL.revokeObjectURL(url);
});

const jsonInput=document.getElementById("jsonImportInput");
document.getElementById("jsonImportBtn").addEventListener("click",()=>jsonInput.click());
jsonInput.addEventListener("change",async e=>{
  const file=e.target.files?.[0]; if(!file) return;
  try{
    const data=JSON.parse(await file.text());
    saveSet(new Set(data.dates));
    alert("JSONを読み込みました");
    render();
    saveToServer(false);  // ←インポート直後に自動保存
  }catch(e){ alert("読み込み失敗"); }
  e.target.value="";
});

document.getElementById("selectMonthBtn").addEventListener("click",()=>{
  const y=current.getFullYear();
  const m=current.getMonth();
  const f=new Date(y,m,1);
  const l=new Date(y,m+1,0);
  const set=loadSet();
  listEligibleWeekdays(f,l).forEach(d=>set.add(fmt(d)));
  saveSet(set);
  render();
  saveToServer(false);  // ←自動保存
});

document.getElementById("quickMarkBtn").addEventListener("click",()=>{
  const now=new Date();
  let target=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  if(now.getHours()<=2) target.setDate(target.getDate()-1);
  if(!inRange(target)) return alert("期間外です");
  if(!isWeekday(target)){
    const t=new Date(target);
    while(!isWeekday(t)) t.setDate(t.getDate()-1);
    target=t;
  }
  const set=loadSet();
  set.add(fmt(target));
  saveSet(set);

  current=new Date(target.getFullYear(),target.getMonth(),1);
  render();
  saveToServer(false);  // ←自動保存
});

document.getElementById("resetBtn").addEventListener("click",()=>{
  if(confirm("この端末とサーバーの出席データをすべて削除します。よろしいですか？")){
    localStorage.removeItem(KEY);
    // ローカルを空にした状態でサーバーへ保存 → サーバー側も空配列になる
    saveToServer(false);
    render();
  }
});

/* 初期表示 */
render();
</script>
</body>
</html>
